name: PR Validate Scenarios

on:
  pull_request:
    paths:
      - "**/*.yml"
      - "**/*.yaml"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install broker
        run: uv tool install broker

      - name: Ensure metadata is not manually edited
        run: |
          changed=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          if echo "$changed" | grep -q '^metadata.yaml$'; then
            echo "metadata.yaml is automation-managed and must not be edited in PRs"
            exit 1
          fi

      - name: Validate changed scenarios
        run: |
          set -euo pipefail
          files=$(git diff --name-only --diff-filter=AM origin/${{ github.base_ref }}...HEAD | grep -E '\.ya?ml$' || true)
          for file in $files; do
            # Skip bot-managed and repo-config files â€” not broker scenarios
            [[ "$file" == "metadata.yaml" ]] && continue
            [[ "$file" == ".pre-commit-config.yaml" ]] && continue
            [[ "$file" == .github/* ]] && continue
            [[ "$file" == scripts/* ]] && continue
            broker scenarios validate "$file" | tee /tmp/validate.out
            if grep -q "is invalid" /tmp/validate.out; then
              exit 1
            fi
          done
