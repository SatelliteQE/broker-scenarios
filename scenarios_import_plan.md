# Broker Scenarios Import Design Specification

This document outlines the plan for implementing the `broker scenarios import` feature, enabling users to discover, download, and manage scenarios from community and private repositories.

Status note: this specification reflects the current decisions from design review (default branch `master`, non-interactive imports proceed with warnings, and metadata is generated by automation rather than edited by humans).

## 1. Repository Structure (The "Community Repo")

To ensure scalability and ease of discovery, the repository will follow a **Provider-First** hierarchical structure.

```text
broker-scenarios/
├── README.md
├── metadata.yaml                    # Global generated metadata (bot-managed)
├── ansibletower/                    # Top-level Provider
│   ├── provisioning/                # Category
│   │   ├── rhel-vm.yaml             # Scenario
│   └── maintenance/
│       └── cleanup-tower.yaml
├── container/
│   ├── testing/
│   │   └── smoke-test.yaml
│   └── podman-setup.yaml            # Scenarios can also live at provider root
├── shared/                          # Multi-provider or utility scenarios
└── examples/                        # Tutorial-focused scenarios
```

### Key Rules:
- **Namespacing:** The directory structure is preserved locally (e.g., `~/.broker/scenarios/ansibletower/provisioning/rhel-vm.yaml`).
- **Metadata Ownership:** `metadata.yaml` is generated and updated by automation only; contributors should not manually edit it.
- **Trust Model:** Repository contributors and users are treated as trusted adults; guardrails focus on automation and validation rather than restrictive path policing.

---

## 2. Importer Architecture

### Platform-Agnostic Adapters
The implementation will use an **Adapter Pattern** to support multiple hosting platforms without leaking platform-specific logic into the core CLI.

- **`GitHubAdapter`:** Uses the GitHub Contents API. Supports `GITHUB_TOKEN` for private repos.
- **`GitLabAdapter`:** Supports `gitlab.com` and self-hosted instances via `GITLAB_TOKEN`.
- **`RawHTTPAdapter`:** Fallback for direct URLs (e.g., raw Gist URLs).

### Network/Retry Behavior
- All remote API/file fetches should use Broker's existing retry helper (with bounded retries and backoff).
- Retry behavior applies to listing, metadata retrieval, and scenario content downloads.
- Final failure should provide concise context (`source`, attempted path/ref, last error).

### Source String Format
The importer will parse strings in the format:
`[platform://]<owner>/<repo>[/<path>][@<ref>]`

*Examples:*
- `SatelliteQE/broker-scenarios` (Defaults to GitHub/master)
- `gitlab.com/my-org/private-scenarios/testing@v2.0`
- `https://raw.githubusercontent.com/.../scenario.yaml`

### Ref Resolution Defaults
- If `@<ref>` is omitted, default to `master`.
- `--update` should re-resolve against the same `source + ref_requested` stored in import tracking.

---

## 3. Command Line Interface (CLI)

The `import` command will be added to the `scenarios` group.

```bash
# Basic Usage
broker scenarios import <source>

# Discovery
broker scenarios import <source> --list          # List remote scenarios without downloading

# Filtering
broker scenarios import <source> --category container
broker scenarios import <source> --name smoke-test

# Management
broker scenarios import <source> --update        # Refresh previously imported scenarios
broker scenarios import --list-imported          # Show history of imports
broker scenarios import <source> --force         # Overwrite local changes
```

---

## 4. The "Soft-Gate" Validation Workflow

Validation is critical but should not prevent a user from importing a scenario they trust.

1. **Fetch:** Download the YAML content to a temporary location.
2. **Validate:** Run `broker.scenarios.validate_scenario()`.
3. **Handle Result:**
   - **Valid:** Proceed to save.
   - **Invalid (Interactive):** Display errors and prompt: `Scenario validation failed. Import anyway? [y/N]`.
  - **Invalid (Non-interactive):** Print a warning to `stderr` and proceed with the requested command behavior (do not block import solely on validation failure).

---

## 5. Import Tracking (`.broker-imports.yaml`)

A manifest file will be maintained at `~/.broker/scenarios/.broker-imports.yaml` to track state.

```yaml
schema_version: 1
imports:
  - source: github.com/SatelliteQE/broker-scenarios/ansibletower
    ref_requested: master
    imported_at: "2026-02-18T12:00:00Z"
    resolved_commit: "a1b2c3d4"
    files:
      - path: ansibletower/provisioning/rhel-vm.yaml
        sha256: "..."
      - path: ansibletower/maintenance/cleanup-tower.yaml
        sha256: "..."
```

This enables the `--update` flag to pull only newer versions and allows Broker to warn users if they are about to overwrite a file they have modified locally.

Versioning policy:
- Unknown future `schema_version` should warn and fall back to best-effort parsing rather than hard-failing.
- Future schema changes should be accompanied by explicit migrations.

---

## 6. External Repository Tooling (Pre-commit + CI)

### Pre-commit checks for contributors
- Use standard hygiene hooks (`check-yaml`, whitespace, EOF fixer).
- Validate only changed scenario files locally with `broker scenarios validate`.
- Block commits that manually modify generated metadata.

Example `.pre-commit-config.yaml` excerpt:

```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: check-yaml
      - id: end-of-file-fixer
      - id: trailing-whitespace

  - repo: local
    hooks:
      - id: validate-scenarios
        name: validate changed scenarios with broker
        language: system
        entry: scripts/validate_changed_scenarios.sh
        pass_filenames: false

      - id: deny-manual-metadata-edit
        name: block manual metadata updates
        language: system
        entry: bash -c 'git diff --cached --name-only | grep -q "^metadata.yaml$" && { echo "metadata.yaml is bot-managed"; exit 1; } || exit 0'
        pass_filenames: false
```

Example `scripts/validate_changed_scenarios.sh`:

```bash
#!/usr/bin/env bash
set -euo pipefail

changed=$(git diff --cached --name-only --diff-filter=AM | grep -E '\\.ya?ml$' || true)

for file in $changed; do
  # validate only scenario files, skip top-level generated metadata
  if [[ "$file" == "metadata.yaml" ]]; then
    continue
  fi
  broker scenarios validate "$file"
done
```

### PR validation workflow
- Install Broker in CI with `uv tool install broker`.
- Compute changed scenario files for the PR (`A/M` only).
- Run `broker scenarios validate <file>` for each changed scenario file.
- Fail the check if validation output indicates invalid scenarios.
- Enforce that metadata is not manually modified in contributor PRs.

Example `.github/workflows/pr-validate.yml` excerpt:

```yaml
name: PR Validate Scenarios

on:
  pull_request:
    paths:
      - "**/*.yml"
      - "**/*.yaml"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install broker
        run: uv tool install broker

      - name: Ensure metadata is not manually edited
        run: |
          changed=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          if echo "$changed" | grep -q '^metadata.yaml$'; then
            echo "metadata.yaml is automation-managed and must not be edited in PRs"
            exit 1
          fi

      - name: Validate changed scenarios
        run: |
          set -euo pipefail
          files=$(git diff --name-only --diff-filter=AM origin/${{ github.base_ref }}...HEAD | grep -E '\\.ya?ml$' || true)
          for file in $files; do
            [[ "$file" == "metadata.yaml" ]] && continue
            broker scenarios validate "$file" | tee /tmp/validate.out
            if grep -q "is invalid" /tmp/validate.out; then
              exit 1
            fi
          done
```

### Metadata generation policy
- `metadata.yaml` should be generated from scenario files and committed only by automation.
- Recommended trigger: workflow on `push` to `master` that regenerates metadata and commits bot-authored updates.
- Deterministic generation (sorted paths, stable YAML formatting) is required to minimize noise.

---

## 7. Implementation Checklist

### Phase 1: Core Support
- [ ] **Recursive Discovery:** Update `list_scenarios()` and `find_scenario()` in `broker/scenarios.py` to support nested directories.
- [ ] **Nested List Display:** Update `broker scenarios list` to group scenarios by their provider/category headers.

### Phase 2: The Importer
- [ ] **Adapters:** Create `broker/helpers/repository_adapters.py`.
- [ ] **Import Logic:** Implement the `import` command in `broker/commands.py`.
- [ ] **Soft-Gate:** Implement interactive prompt on invalid scenarios and warning-only behavior for non-interactive mode.
- [ ] **Retry Integration:** Use existing retry helper for remote list/download operations.

### Phase 3: Configuration
- [ ] **Settings:** Add `github_token` and `gitlab_instances` to `broker_settings.yaml`.
- [ ] **Metadata Tracking:** Implement `.broker-imports.yaml` with `schema_version`, `ref_requested`, `resolved_commit`, and per-file hash data.

### Phase 4: Scenario Repository Automation
- [ ] **Pre-commit:** Add local hooks for YAML hygiene, changed-file scenario validation, and manual metadata edit blocking.
- [ ] **PR Action:** Add workflow that installs Broker via `uv tool install broker` and validates each changed scenario file.
- [ ] **Metadata Bot Update:** Add post-merge automation on `master` to regenerate and commit `metadata.yaml`.
